model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique // Auto-generated order number
  storeId         String
  customerName    String?
  customerEmail   String?
  customerPhone   String?
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal     @db.Decimal(10, 2)
  discountAmount  Decimal     @default(0) @db.Decimal(10, 2)
  taxAmount       Decimal     @default(0) @db.Decimal(10, 2)
  shippingAmount  Decimal     @default(0) @db.Decimal(10, 2)
  finalAmount     Decimal     @db.Decimal(10, 2)
  couponId        String?
  flashSaleId     String?
  notes           String?
  shippingAddress Json? // Full address object
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?

  store     Store          @relation(fields: [storeId], references: [id])
  coupon    Coupon?        @relation(fields: [couponId], references: [id])
  flashSale FlashSale?     @relation(fields: [flashSaleId], references: [id])
  items     OrderItem[]
  payments  Payment[]
  invoices  Invoice[]
  history   OrderHistory[]

  @@index([id, storeId])
  @@index([orderNumber])
  @@index([status, storeId])
  @@index([createdAt, storeId])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  productId  String
  variantId  String? // Optional: if order item is a variant
  quantity   Int
  unitPrice  Decimal  @db.Decimal(10, 2)
  discount   Decimal  @default(0) @db.Decimal(10, 2)
  totalPrice Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@map("order_items")
}

model OrderHistory {
  id        String       @id @default(cuid())
  orderId   String
  userId    String
  action    String
  status    OrderStatus?
  reason    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  deletedAt DateTime?
  meta      Json?

  order Order @relation(fields: [orderId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@index([orderId, createdAt])
  @@map("order_history")
}
