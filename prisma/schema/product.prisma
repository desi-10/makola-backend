model Product {
  id               String    @id @default(cuid())
  name             String
  description      String?
  shortDescription String? // Short description for listings
  slug             String? // SEO-friendly URL slug
  sku              String?
  barcode          String? // UPC, EAN, ISBN, etc.
  modelNumber      String?
  storeId          String
  categoryId       String?
  brandId          String?
  // Pricing
  price            Decimal   @db.Decimal(10, 2) // Selling price
  costPrice        Decimal?  @db.Decimal(10, 2) // Cost price for profit calculation
  comparePrice     Decimal?  @db.Decimal(10, 2) // MSRP/Compare at price
  // Physical attributes
  weight           Decimal?  @db.Decimal(10, 2) // Weight in kg or lbs
  length           Decimal?  @db.Decimal(10, 2) // Length in cm or inches
  width            Decimal?  @db.Decimal(10, 2) // Width in cm or inches
  height           Decimal?  @db.Decimal(10, 2) // Height in cm or inches
  // Product status
  condition        String? // "new", "used", "refurbished", etc.
  warrantyDuration String? // e.g., "1 year", "90 days"
  isFeatured       Boolean   @default(false)
  isActive         Boolean   @default(true)
  // SEO
  metaTitle        String?
  metaDescription  String?
  // Media
  image            String? // Primary image (backward compatibility)
  videoUrl         String?
  // Shipping
  shippingClass    String? // Shipping class/category
  taxCategory      String? // Tax category for tax calculations
  // Timestamps
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?

  store               Store                  @relation(fields: [storeId], references: [id])
  category            Category?              @relation(fields: [categoryId], references: [id])
  brand               Brand?                 @relation(fields: [brandId], references: [id])
  history             ProductHistory[]
  inventory           Inventory[]            @relation("ProductInventory")
  variants            ProductVariant[]
  images              ProductImage[]
  specifications      ProductSpecification[]
  tagRelations        ProductTagRelation[]
  orderItems          OrderItem[]
  cartItems           CartItem[]
  flashSaleProducts   Json? // Array of product IDs for flashsales (if needed)

  @@unique([storeId, name])
  @@unique([storeId, sku])
  @@unique([storeId, barcode])
  @@unique([slug, storeId])
  @@index([id, storeId])
  @@index([id, storeId, isActive])
  @@index([brandId])
  @@index([categoryId])
  @@index([slug])
  @@map("products")
}

model ProductHistory {
  id        String    @id @default(cuid())
  productId String
  userId    String
  action    String
  reason    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  meta      Json?

  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@map("product_history")
}

// ========================================================
// PRODUCT VARIANTS
// ========================================================
model ProductVariant {
  id           String    @id @default(cuid())
  productId    String
  name         String // e.g., "Size: Large, Color: Red"
  sku          String?
  barcode      String?
  // Pricing (if different from product)
  price        Decimal?  @db.Decimal(10, 2)
  costPrice    Decimal?  @db.Decimal(10, 2)
  comparePrice Decimal?  @db.Decimal(10, 2)
  // Physical attributes (if different from product)
  weight       Decimal?  @db.Decimal(10, 2)
  length       Decimal?  @db.Decimal(10, 2)
  width        Decimal?  @db.Decimal(10, 2)
  height       Decimal?  @db.Decimal(10, 2)
  // Variant attributes (JSON for flexibility: {size: "L", color: "Red"})
  attributes   Json? // e.g., {"size": "L", "color": "Red", "material": "Cotton"}
  image        String? // Variant-specific image
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  product    Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventory  VariantInventory[]
  orderItems OrderItem[]
  cartItems  CartItem[]

  @@unique([productId, sku])
  @@unique([productId, barcode])
  @@index([id, productId])
  @@index([id, productId, isActive])
  @@map("product_variants")
}

model VariantInventory {
  id                String    @id @default(cuid())
  variantId         String
  storeId           String
  quantity          Int       @default(0)
  reserved          Int       @default(0) // Quantity reserved for pending orders
  totalPurchased    Int       @default(0) // Total quantity of items purchased/sold
  lowStockThreshold Int? // Alert when stock falls below this
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  variant ProductVariant            @relation(fields: [variantId], references: [id], onDelete: Cascade)
  store   Store                     @relation("StoreVariantInventory", fields: [storeId], references: [id])
  history VariantInventoryHistory[]

  @@unique([variantId, storeId])
  @@index([id, storeId])
  @@index([id, storeId, isActive])
  @@map("variant_inventory")
}

model VariantInventoryHistory {
  id               String    @id @default(cuid())
  inventoryId      String
  userId           String
  action           String // "adjust", "reserve", "release", "sale", "return", "restock"
  quantity         Int
  previousQuantity Int
  newQuantity      Int
  reason           String?
  ipAddress        String?
  userAgent        String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?
  meta             Json?

  inventory VariantInventory @relation(fields: [inventoryId], references: [id])
  user      User             @relation(fields: [userId], references: [id])

  @@index([inventoryId, createdAt])
  @@map("variant_inventory_history")
}

// ========================================================
// PRODUCT IMAGES
// ========================================================
model ProductImage {
  id        String    @id @default(cuid())
  productId String
  url       String
  alt       String? // Alt text for accessibility
  order     Int       @default(0) // Display order
  isPrimary Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, order])
  @@index([productId, isPrimary])
  @@map("product_images")
}

// ========================================================
// PRODUCT TAGS
// ========================================================
model ProductTag {
  id        String    @id @default(cuid())
  name      String
  storeId   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  store    Store                @relation(fields: [storeId], references: [id])
  products ProductTagRelation[]

  @@unique([storeId, name])
  @@index([id, storeId])
  @@map("product_tags")
}

model ProductTagRelation {
  id        String   @id @default(cuid())
  productId String
  tagId     String
  createdAt DateTime @default(now())

  product Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     ProductTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])
  @@index([productId])
  @@index([tagId])
  @@map("product_tag_relations")
}

// ========================================================
// PRODUCT SPECIFICATIONS
// ========================================================
model ProductSpecification {
  id        String    @id @default(cuid())
  productId String
  key       String // e.g., "Screen Size", "RAM", "Storage"
  value     String // e.g., "6.1 inches", "8GB", "256GB"
  order     Int       @default(0) // Display order
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, order])
  @@map("product_specifications")
}
